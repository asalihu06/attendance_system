{% extends 'dashboard/base.html' %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark">Monthly Attendance Insights</h3>
        
        <form method="get" class="row g-2 align-items-center">
            <div class="col-auto">
                <label for="month" class="col-form-label small fw-bold text-muted">Select Month:</label>
            </div>
            <div class="col-auto">
                <input type="month" id="month" name="month" value="{{ request.GET.month }}" class="form-control border-0 shadow-sm">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn text-white px-4 shadow-sm" style="background-color: #E74E37;">
                    <i class="fa-solid fa-filter me-2"></i>View Report
                </button>
            </div>
        </form>
    </div>

    {% if summary_data %}
    <div class="row mb-4 g-3">
        <div class="col-md-7">
            <div class="card border-0 shadow-sm p-4 h-100">
                <div class="d-flex align-items-center mb-3">
                    <i class="fa-solid fa-calendar-days fs-4 me-3" style="color: #E74E37;"></i>
                    <h5 class="mb-0 fw-bold">{{ summary_data.month_display }}</h5>
                </div>
                <div class="row text-center">
                    <div class="col-4 border-end">
                        <small class="text-muted d-block">Total Records</small>
                        <strong class="fs-5">{{ summary_data.total_records }}</strong>
                    </div>
                    <div class="col-4 border-end">
                        <small class="text-muted d-block">Avg Daily</small>
                        <strong class="fs-5 text-success">{{ summary_data.average_daily }}</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">Peak Day</small>
                        <strong class="fs-5 text-primary">{{ summary_data.highest_day }}</strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card border-0 shadow-sm h-100 d-flex align-items-center justify-content-center p-4">
                <div class="text-center">
                    <p class="text-muted small mb-3">Need a hard copy for HR?</p>
                    <a href="{% url 'download_report_pdf' %}?month={{ summary_data.month }}" class="btn btn-danger btn-lg px-4 shadow-sm py-3">
                        <i class="fa-solid fa-file-pdf me-2"></i>Download PDF Report
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-0 shadow-sm p-4">
                <h6 class="fw-bold mb-4 text-muted text-uppercase small">Attendance Distribution</h6>
                <div style="max-height: 300px; position: relative;">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card border-0 shadow-sm p-4">
        <h6 class="fw-bold mb-4 text-muted text-uppercase small">Attendance Trend (Last 7 Days)</h6>
        <div style="height: 300px;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if chart_data %}
<script>
// Logic preserved: Chart IDs and Data keys are exact
const attendanceCtx = document.getElementById('attendanceChart');
if (attendanceCtx) {
    new Chart(attendanceCtx, {
        type: 'doughnut', // Updated to doughnut for a modern look
        data: {
            labels: ['On Time', 'Late', 'Absent'],
            datasets: [{
                data: [{{ chart_data.on_time }}, {{ chart_data.late }}, {{ chart_data.absent }}],
                backgroundColor: ['#198754', '#ffc107', '#E74E37'], // Updated absent color to Brand Orange
                borderWidth: 0
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { usePointStyle: true } },
            },
            cutout: '70%'
        }
    });
}
</script>
{% endif %}

{% if trend_labels and trend_values %}
<script>
// Logic preserved: trend_labels and trend_values are exact
const trendCtx = document.getElementById('trendChart');
if (trendCtx) {
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ trend_labels|safe }},
            datasets: [{
                label: 'Total Attendance',
                data: {{ trend_values|safe }},
                borderColor: '#E74E37', // Brand Orange
                backgroundColor: 'rgba(231, 78, 55, 0.1)',
                fill: true,
                tension: 0.4, // Smoother line
                pointRadius: 5,
                pointBackgroundColor: '#E74E37'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#f0f0f0' }, ticks: { stepSize: 1 } },
                x: { grid: { display: false } }
            }
        }
    });
}
</script>
{% endif %}
{% endblock %}