{% extends "dashboard/base.html" %}
{% load static %}

{% block content %}
<style>
    /* Professional Welcome Banner */
    .welcome-banner {
        background: linear-gradient(135deg, var(--sidebar-dark) 0%, #2d3436 100%);
        color: white;
        padding: 40px;
        border-radius: 20px;
        margin-bottom: 40px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    /* Orange Profile Icon replacing the logo box */
    .header-profile-icon {
        font-size: 5.5rem;
        color: #E74E37; /* Brand Orange */
        opacity: 0.9;
        filter: drop-shadow(0 0 10px rgba(231, 78, 55, 0.2));
    }

    .text-orange { color: #E74E37 !important; }
    .border-brand { border-top-color: #E74E37 !important; }
    .smaller { font-size: 0.8rem; }
    .bg-orange-light { background-color: rgba(231, 78, 55, 0.1); color: #E74E37; }
    
    /* Stats Card Hover Effect */
    .card { transition: transform 0.2s ease; border-radius: 15px; }
    .card:hover { transform: translateY(-3px); }

    .feature-icon-small {
        width: 45px; 
        height: 45px; 
        border-radius: 12px;
    }

    .btn-brand-primary {
    background-color: #E74E37 !important; /* Your Brand Orange */
    color: white !important;
    border: none;
    font-weight: 600;
    border-radius: 8px;
    padding-top: 10px;
    padding-bottom: 10px;
    transition: all 0.3s ease;
}

.btn-brand-primary:hover {
    background-color: #cf3f2c !important; /* Slightly darker orange for hover */
    color: white !important;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(231, 78, 55, 0.4) !important;
}

.btn-brand-primary:active {
    transform: translateY(0);
}
</style>

<div class="container-fluid">
    <div class="welcome-banner shadow-sm">
        <div>
            <h1 class="fw-bold mb-2">Welcome back, Admin!</h1>
            <p class="mb-0 opacity-75 fs-5">
                <i class="fa-regular fa-calendar-check me-2 text-orange"></i> {{ today|date:"M d, Y" }} | System Overview
            </p>
        </div>
        
        <div class="d-none d-lg-block me-3">
            <i class="fa-solid fa-circle-user header-profile-icon"></i>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="card text-center border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="feature-icon-small d-inline-flex align-items-center justify-content-center text-white mb-2" style="background-color: #6c757d;">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <h6 class="card-title text-muted mb-1">Total Staff</h6>
                    <p id="total-staff" class="fs-3 fw-bold mb-0" style="color: #2d3436;">{{ total_staff }}</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card text-center border-0 shadow-sm h-100 border-top border-4 border-brand">
                <div class="card-body">
                    <div class="feature-icon-small d-inline-flex align-items-center justify-content-center text-white mb-2" style="background-color: #E74E37;">
                        <i class="fa-solid fa-clipboard-user"></i>
                    </div>
                    <h6 class="card-title text-muted mb-1">Total Present</h6>
                    <p id="todays-attendance" class="fs-3 fw-bold mb-0 text-orange">{{ todays_attendance }}</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card text-center border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="feature-icon-small d-inline-flex align-items-center justify-content-center text-success bg-success bg-opacity-10 mb-2">
                        <i class="fa-solid fa-right-to-bracket"></i>
                    </div>
                    <h6 class="card-title text-muted mb-1">Active Now</h6>
                    <p id="signed-in" class="fs-3 fw-bold mb-0 text-success">{{ signed_in_count }}</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card text-center border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="feature-icon-small d-inline-flex align-items-center justify-content-center text-danger bg-danger bg-opacity-10 mb-2">
                        <i class="fa-solid fa-user-slash"></i>
                    </div>
                    <h6 class="card-title text-muted mb-1">Absent</h6>
                    <p id="absent-count" class="fs-3 fw-bold mb-0 text-danger">{{ absent_count }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 border-0">
                    <h5 class="mb-0 fw-bold"><i class="fa-solid fa-list-check me-2 text-orange"></i>Live Logs</h5>
                </div>
                <div class="table-responsive p-3">
                    <table class="table table-hover align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0 text-muted small">STAFF</th>
                                <th class="border-0 text-muted small">DEPT</th>
                                <th class="border-0 text-muted small">TIME IN</th>
                                <th class="border-0 text-muted small">STATUS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in attendance_records %}
                            <tr>
                                <td>
                                    <div class="fw-bold">{{ record.staff.name }}</div>
                                    <div class="text-muted smaller" style="font-size: 0.75rem;">ID: {{ record.staff.staff_id }}</div>
                                </td>
                                <td>{{ record.staff.department }}</td>
                                <td>{{ record.time_in|default:"--" }}</td>
                                <td>
                                    <span class="badge rounded-pill 
                                        {% if record.status == 'On Time' %}bg-success bg-opacity-10 text-success
                                        {% elif record.status == 'Late' %}bg-warning bg-opacity-10 text-warning
                                        {% elif record.status == 'Signed Out' %}bg-info bg-opacity-10 text-info
                                        {% else %}bg-danger bg-opacity-10 text-danger{% endif %} p-2 px-3">
                                        {{ record.status }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-4 text-muted">No logs recorded for today.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 border-0">
                    <h5 class="mb-0 fw-bold"><i class="fa-solid fa-chart-line me-2 text-orange"></i>Weekly Trend</h5>
                </div>
                <div class="card-body p-3">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const ctx = document.getElementById('trendChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ labels|safe }},
            datasets: [{
                label: 'Attendance',
                data: {{ attendance_counts|safe }},
                borderColor: '#E74E37',
                backgroundColor: 'rgba(231, 78, 55, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: '#E74E37',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { display: false }, ticks: { stepSize: 1 } },
                x: { grid: { display: false } }
            }
        }
    });
});

function refreshDashboardCards() {
    fetch("{% url 'dashboard_stats' %}")
        .then(response => response.json())
        .then(data => {
            document.getElementById("total-staff").textContent = data.total_staff;
            document.getElementById("todays-attendance").textContent = data.todays_attendance;
            document.getElementById("signed-in").textContent = data.signed_in;
            document.getElementById("absent-count").textContent = data.absent_count;
        });
}
setInterval(refreshDashboardCards, 30000);
</script>
{% endblock %}